input_boolean:
  hc_dispatcher_advisory_enabled:
    name: HC Dispatcher Advisory Enabled
    icon: mdi:radar

input_select:
  hc_dispatch_algorithm:
    name: HC Dispatch Algorithm
    options:
      - Profile
      - Matrix
    initial: Profile

  hc_dispatch_profile:
    name: HC Dispatch Profile
    options:
      - None
      - Basement (Z3+Z7+Z9)
      - First Floor (Z1+Z5+Z8)
      - Upper Floor (Z2+Z6)
      - Whole House (Z1-Z9)
    initial: Basement (Z3+Z7+Z9)

input_number:
  hc_dispatch_batch_window_sec:
    name: HC Dispatch Batch Window
    min: 30
    max: 600
    step: 10
    unit_of_measurement: s
    initial: 180
    icon: mdi:timer-sand

  hc_dispatch_near_call_margin_f:
    name: HC Dispatch Near-Call Margin
    min: 0.0
    max: 2.0
    step: 0.1
    unit_of_measurement: "°F"
    initial: 0.3
    icon: mdi:arrow-expand-vertical

input_datetime:
  hc_dispatch_last_on_z1: { name: "HC Dispatch Last ON Z1", has_date: true, has_time: true }
  hc_dispatch_last_on_z2: { name: "HC Dispatch Last ON Z2", has_date: true, has_time: true }
  hc_dispatch_last_on_z3: { name: "HC Dispatch Last ON Z3", has_date: true, has_time: true }
  hc_dispatch_last_on_z4: { name: "HC Dispatch Last ON Z4", has_date: true, has_time: true }
  hc_dispatch_last_on_z5: { name: "HC Dispatch Last ON Z5", has_date: true, has_time: true }
  hc_dispatch_last_on_z6: { name: "HC Dispatch Last ON Z6", has_date: true, has_time: true }
  hc_dispatch_last_on_z7: { name: "HC Dispatch Last ON Z7", has_date: true, has_time: true }
  hc_dispatch_last_on_z8: { name: "HC Dispatch Last ON Z8", has_date: true, has_time: true }
  hc_dispatch_last_on_z9: { name: "HC Dispatch Last ON Z9", has_date: true, has_time: true }

counter:
  hc_dispatch_calls_z1_today: { name: "HC Z1 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z2_today: { name: "HC Z2 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z3_today: { name: "HC Z3 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z4_today: { name: "HC Z4 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z5_today: { name: "HC Z5 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z6_today: { name: "HC Z6 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z7_today: { name: "HC Z7 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z8_today: { name: "HC Z8 Call Starts Today", initial: 0, icon: mdi:counter }
  hc_dispatch_calls_z9_today: { name: "HC Z9 Call Starts Today", initial: 0, icon: mdi:counter }

  # Pair proximity counters (increment when second zone starts within window of first)
  hc_dispatch_pair_z3_z7: { name: "HC Pair Z3↔Z7 Within Window", initial: 0, icon: mdi:link-variant }
  hc_dispatch_pair_z3_z9: { name: "HC Pair Z3↔Z9 Within Window", initial: 0, icon: mdi:link-variant }
  hc_dispatch_pair_z7_z9: { name: "HC Pair Z7↔Z9 Within Window", initial: 0, icon: mdi:link-variant }
  hc_dispatch_pair_z1_z5: { name: "HC Pair Z1↔Z5 Within Window", initial: 0, icon: mdi:link-variant }
  hc_dispatch_pair_z1_z8: { name: "HC Pair Z1↔Z8 Within Window", initial: 0, icon: mdi:link-variant }
  hc_dispatch_pair_z5_z8: { name: "HC Pair Z5↔Z8 Within Window", initial: 0, icon: mdi:link-variant }
  hc_dispatch_pair_z2_z6: { name: "HC Pair Z2↔Z6 Within Window", initial: 0, icon: mdi:link-variant }

template:
  - sensor:
      - name: "HC Dispatch Active Zones"
        unique_id: hc_dispatch_active_zones
        icon: mdi:fire
        state: >
          {% set ns = namespace(zones=[]) %}
          {% for z in range(1,10) %}
            {% if is_state('binary_sensor.hc_z' ~ z ~ '_call_for_heat','on') %}
              {% set ns.zones = ns.zones + ['z' ~ z] %}
            {% endif %}
          {% endfor %}
          {{ ns.zones | join(',') if ns.zones|length else 'none' }}

      - name: "HC Dispatch Near-Call Zones"
        unique_id: hc_dispatch_near_call_zones
        icon: mdi:thermometer-chevron-up
        state: >
          {% set tol = states('input_number.hc_cold_tolerance')|float(0) %}
          {% set m = states('input_number.hc_dispatch_near_call_margin_f')|float(0.3) %}
          {% set ns = namespace(zones=[]) %}
          {% for z in range(1,10) %}
            {% set calling = is_state('binary_sensor.hc_z' ~ z ~ '_call_for_heat','on') %}
            {% set d = states('sensor.hc_z' ~ z ~ '_delta') %}
            {% if (not calling) and d not in ['unknown','unavailable','none'] %}
              {% set dv = d|float(0) %}
              {% if dv >= (tol - m) and dv < tol %}
                {% set ns.zones = ns.zones + ['z' ~ z] %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ ns.zones | join(',') if ns.zones|length else 'none' }}

      - name: "HC Dispatch Guardrail Payload"
        unique_id: hc_dispatch_guardrail_payload
        icon: mdi:code-json
        state: >
          {% set algorithm = states('input_select.hc_dispatch_algorithm') %}
          {% if algorithm in ['unknown','unavailable','none',''] %}
            {% set algorithm = 'Profile' %}
          {% endif %}
          {% set profile = states('input_select.hc_dispatch_profile') %}

          {% set labels = {
            'z1':'Z1 1F Bed/Bath','z2':'Z2 Office+Guest','z3':'Z3 Bsm Bath+Common',
            'z4':'Z4 Garage','z5':'Z5 1F Living','z6':'Z6 Master','z7':'Z7 Bsm Bar+TV',
            'z8':'Z8 Dining','z9':'Z9 Bsm Bedroom'
          } %}

          {% set lengths = {
            'z1': states('input_number.hc_z1_length_feet')|float(0),
            'z2': states('input_number.hc_z2_length_feet')|float(0),
            'z3': states('input_number.hc_z3_length_feet')|float(0),
            'z4': states('input_number.hc_z4_length_feet')|float(0),
            'z5': states('input_number.hc_z5_length_feet')|float(0),
            'z6': states('input_number.hc_z6_length_feet')|float(0),
            'z7': states('input_number.hc_z7_length_feet')|float(0),
            'z8': states('input_number.hc_z8_length_feet')|float(0),
            'z9': states('input_number.hc_z9_length_feet')|float(0)
          } %}

          {% set max_ft = states('input_number.hc_dispatch_max_batch_length_ft')|float(85) %}
          {% set opp_min = states('input_number.hc_dispatch_opportunistic_min_ft')|float(50) %}
          {% set opp_max = states('input_number.hc_dispatch_opportunistic_max_ft')|float(70) %}
          {% set opp_enabled = is_state('input_boolean.hc_dispatch_opportunistic_enabled','on') %}
          {% set manual_override = is_state('input_boolean.hc_dispatch_manual_override','on') %}

          {% set tol = states('input_number.hc_cold_tolerance')|float(0) %}
          {% set m = states('input_number.hc_dispatch_near_call_margin_f')|float(0.3) %}

          {% set active_ns = namespace(list=[]) %}
          {% for z in range(1,10) %}
            {% if is_state('binary_sensor.hc_z' ~ z ~ '_call_for_heat','on') %}
              {% set active_ns.list = active_ns.list + ['z' ~ z] %}
            {% endif %}
          {% endfor %}
          {% set active = active_ns.list %}

          {% set near_ns = namespace(list=[]) %}
          {% for z in range(1,10) %}
            {% set calling = is_state('binary_sensor.hc_z' ~ z ~ '_call_for_heat','on') %}
            {% set d = states('sensor.hc_z' ~ z ~ '_delta') %}
            {% if (not calling) and d not in ['unknown','unavailable','none'] %}
              {% set dv = d|float(0) %}
              {% if dv >= (tol - m) and dv < tol %}
                {% set near_ns.list = near_ns.list + ['z' ~ z] %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set near = near_ns.list %}

          {% set base_zones = [] %}
          {% set final_zones = [] %}
          {% set guardrail = 'idle' %}
          {% set base_length = 0 %}
          {% set callers_length = 0 %}

          {# Algorithm branch #}
          {% if active|length == 0 %}
            {% set guardrail = 'idle' %}
          {% elif algorithm == 'Matrix' %}
            {% set clusters = { 
              'z1': states('input_select.hc_z1_cluster'),
              'z2': states('input_select.hc_z2_cluster'),
              'z3': states('input_select.hc_z3_cluster'),
              'z4': states('input_select.hc_z4_cluster'),
              'z5': states('input_select.hc_z5_cluster'),
              'z6': states('input_select.hc_z6_cluster'),
              'z7': states('input_select.hc_z7_cluster'),
              'z8': states('input_select.hc_z8_cluster'),
              'z9': states('input_select.hc_z9_cluster')
            } %}

            {% set ns = namespace(active_zones=active, active_clusters=[]) %}

            {# Identify active clusters from calling zones #}
            {% for z in ns.active_zones %}
              {% set c = clusters[z] %}
              {% if c != 'Independent' and c not in ns.active_clusters %}
                {% set ns.active_clusters = ns.active_clusters + [c] %}
              {% endif %}
            {% endfor %}

            {# Add follower zones that share active clusters #}
            {% for z in ['z1','z2','z3','z4','z5','z6','z7','z8','z9'] %}
              {% if z not in ns.active_zones %}
                {% set c = clusters[z] %}
                {% if c in ns.active_clusters %}
                  {% set ns.active_zones = ns.active_zones + [z] %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {# Near-call candidates for Independent zones only #}
            {% set near_ind_ns = namespace(list=[]) %}
            {% for z in ['z1','z2','z3','z4','z5','z6','z7','z8','z9'] %}
              {% if z not in ns.active_zones %}
                {% set c = clusters[z] %}
                {% if c == 'Independent' %}
                  {% set d = states('sensor.hc_' ~ z ~ '_delta') %}
                  {% if d not in ['unknown','unavailable','none'] %}
                    {% set dv = d|float(0) %}
                    {% if dv >= (tol - m) and dv < tol %}
                      {% set near_ind_ns.list = near_ind_ns.list + [z] %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {% set base_zones = ns.active_zones | unique | list %}
            {% set near_candidates = near_ind_ns.list %}
          {% else %}
            {% set groups = {
              'Basement (Z3+Z7+Z9)': ['z3','z7','z9'],
              'First Floor (Z1+Z5+Z8)': ['z1','z5','z8'],
              'Upper Floor (Z2+Z6)': ['z2','z6'],
              'Whole House (Z1-Z9)': ['z1','z2','z3','z4','z5','z6','z7','z8','z9'],
              'None': []
            } %}
            {% set group = groups.get(profile, []) %}

            {% set base_zones = active %}
            {% if group|length > 0 %}
              {% set active_in_group = active | select('in', group) | list %}
              {% if active_in_group|length > 0 %}
                {% set base_zones = group %}
              {% elif profile == 'Whole House (Z1-Z9)' %}
                {% set base_zones = group %}
              {% endif %}
            {% endif %}

            {% set base_zones = base_zones | unique | list %}
            {% set near_candidates = near %}
          {% endif %}

          {# Compute base and callers length #}
          {% set base_len_ns = namespace(total=0) %}
          {% for z in base_zones %}
            {% set base_len_ns.total = base_len_ns.total + lengths.get(z, 0) %}
          {% endfor %}
          {% set base_length = base_len_ns.total %}

          {% set callers = active %}
          {% set callers_len_ns = namespace(total=0) %}
          {% for z in callers %}
            {% set callers_len_ns.total = callers_len_ns.total + lengths.get(z, 0) %}
          {% endfor %}
          {% set callers_length = callers_len_ns.total %}

          {% set guardrail = 'ok' %}
          {% set final_zones = base_zones %}

          {# Hard cap: degrade to callers-only if base exceeds max #}
          {% if base_length > max_ft %}
            {% set guardrail = 'degraded_to_callers' %}
            {% if callers_length > max_ft %}
              {% set guardrail = 'blocked_over_max' %}
              {% set final_zones = [] %}
            {% else %}
              {% set final_zones = callers %}
            {% endif %}
          {% else %}
            {% set final_zones = base_zones %}

            {# Opportunistic additions within guardrails #}
            {% if opp_enabled and final_zones|length > 0 %}
              {% set total_ns = namespace(total=base_length) %}
              {% set added_ns = namespace(list=[]) %}
              {% set limit_max = max_ft if manual_override else opp_max %}

              {% for z in near_candidates %}
                {% if z not in final_zones %}
                  {% set zlen = lengths.get(z, 0) %}
                  {% if (total_ns.total + zlen) <= limit_max %}
                    {% set total_ns.total = total_ns.total + zlen %}
                    {% set added_ns.list = added_ns.list + [z] %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {% if not manual_override %}
                {% if total_ns.total < opp_min %}
                  {% set added_ns.list = [] %}
                  {% set total_ns.total = base_length %}
                  {% set guardrail = 'opportunistic_skipped_under_min' %}
                {% elif added_ns.list|length > 0 %}
                  {% set guardrail = 'opportunistic_applied' %}
                {% endif %}
              {% else %}
                {% if added_ns.list|length > 0 %}
                  {% set guardrail = 'opportunistic_applied_override' %}
                {% endif %}
              {% endif %}

              {% set final_zones = (final_zones + added_ns.list) | unique | list %}
            {% endif %}
          {% endif %}

          {% if final_zones|length == 0 %}
            {% set suggested_batch = 'idle' %}
            {% set guardrail = 'idle' %}
          {% else %}
            {% set out_ns = namespace(list=[]) %}
            {% for z in final_zones | sort %}
              {% set out_ns.list = out_ns.list + [labels.get(z, z|upper)] %}
            {% endfor %}
            {% set suggested_batch = out_ns.list | join(' + ') %}
          {% endif %}

          {% set batch_len_ns = namespace(total=0) %}
          {% for z in final_zones %}
            {% set batch_len_ns.total = batch_len_ns.total + lengths.get(z, 0) %}
          {% endfor %}
          {% set batch_length = batch_len_ns.total %}

          {% set alg_code = 'M' if algorithm == 'Matrix' else 'P' %}
          {% set prof_code = {
            'Basement (Z3+Z7+Z9)': 'B',
            'First Floor (Z1+Z5+Z8)': 'F',
            'Upper Floor (Z2+Z6)': 'U',
            'Whole House (Z1-Z9)': 'W',
            'None': 'N'
          }.get(profile, 'N') %}
          {% set result = {
            'g': guardrail,
            'bz': (base_zones | join(',') if base_zones|length else 'none'),
            'fz': (final_zones | join(',') if final_zones|length else 'none'),
            'bl': base_length|round(1),
            'cl': callers_length|round(1),
            'fl': batch_length|round(1),
            'ml': max_ft,
            'omin': opp_min,
            'omax': opp_max,
            'a': alg_code,
            'p': prof_code,
            'opp': 1 if opp_enabled else 0,
            'man': 1 if manual_override else 0,
            'bw': states('input_number.hc_dispatch_batch_window_sec')|int(180),
            'gate': 1 if is_state('input_boolean.hc_enable_cold_tolerance_gate','on') else 0,
            'gt': states('input_number.hc_cold_tolerance')|float(0),
            'imin': states('input_number.hc_dispatch_ideal_min_ft')|float(0),
            'imax': states('input_number.hc_dispatch_ideal_max_ft')|float(0)
          } %}
          {{ result | tojson }}
        attributes:
          suggested_batch: "{{ (payload | from_json).suggested_batch }}"
          algorithm: "{{ (payload | from_json).algorithm }}"
          profile: "{{ (payload | from_json).profile }}"
          batch_window_sec: "{{ (payload | from_json).batch_window_sec }}"
          gate_enabled: "{{ (payload | from_json).gate_enabled }}"
          gate_threshold_f: "{{ (payload | from_json).gate_threshold_f }}"
          guardrail_status: "{{ (payload | from_json).guardrail }}"
          batch_length_ft: "{{ (payload | from_json).batch_length_ft }}"
          base_length_ft: "{{ (payload | from_json).base_length_ft }}"
          callers_length_ft: "{{ (payload | from_json).callers_length_ft }}"
          max_length_ft: "{{ (payload | from_json).max_length_ft }}"
          ideal_min_ft: "{{ (payload | from_json).ideal_min_ft }}"
          ideal_max_ft: "{{ (payload | from_json).ideal_max_ft }}"
          opportunistic_enabled: "{{ (payload | from_json).opportunistic_enabled }}"
          opportunistic_min_ft: "{{ (payload | from_json).opportunistic_min_ft }}"
          opportunistic_max_ft: "{{ (payload | from_json).opportunistic_max_ft }}"
          manual_override: "{{ (payload | from_json).manual_override }}"
          base_zones: "{{ (payload | from_json).base_zones }}"
          final_zones: "{{ (payload | from_json).final_zones }}"

      - name: "HC Dispatch Guardrail"
        unique_id: hc_dispatch_guardrail
        icon: mdi:vector-link
        state: >
          {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
          {% if p in ['unknown','unavailable','none',''] %}
            idle
          {% else %}
            {{ (p | from_json).g }}
          {% endif %}
        attributes:
          suggested_batch: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {% if p in ['unknown','unavailable','none',''] %}
              idle
            {% else %}
              {% set labels = {
                'z1':'Z1 1F Bed/Bath','z2':'Z2 Office+Guest','z3':'Z3 Bsm Bath+Common',
                'z4':'Z4 Garage','z5':'Z5 1F Living','z6':'Z6 Master','z7':'Z7 Bsm Bar+TV',
                'z8':'Z8 Dining','z9':'Z9 Bsm Bedroom'
              } %}
              {% set fz = (p | from_json).fz %}
              {% if fz in ['none',''] %}
                idle
              {% else %}
                {% set out_ns = namespace(list=[]) %}
                {% for z in fz.split(',') %}
                  {% set out_ns.list = out_ns.list + [labels.get(z, z|upper)] %}
                {% endfor %}
                {{ out_ns.list | join(' + ') }}
              {% endif %}
            {% endif %}
          algorithm: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {% if p in ['unknown','unavailable','none',''] %}
              Profile
            {% else %}
              {% set a = (p | from_json).a %}
              {{ 'Matrix' if a == 'M' else 'Profile' }}
            {% endif %}
          profile: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {% if p in ['unknown','unavailable','none',''] %}
              None
            {% else %}
              {% set code = (p | from_json).p %}
              {% set map = {
                'B':'Basement (Z3+Z7+Z9)',
                'F':'First Floor (Z1+Z5+Z8)',
                'U':'Upper Floor (Z2+Z6)',
                'W':'Whole House (Z1-Z9)',
                'N':'None'
              } %}
              {{ map.get(code, 'None') }}
            {% endif %}
          batch_window_sec: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).bw if p not in ['unknown','unavailable','none',''] else 180 }}
          gate_enabled: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ ((p | from_json).gate == 1) if p not in ['unknown','unavailable','none',''] else false }}
          gate_threshold_f: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).gt if p not in ['unknown','unavailable','none',''] else 0 }}
          guardrail_status: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).g if p not in ['unknown','unavailable','none',''] else 'idle' }}
          batch_length_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).fl if p not in ['unknown','unavailable','none',''] else 0 }}
          base_length_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).bl if p not in ['unknown','unavailable','none',''] else 0 }}
          callers_length_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).cl if p not in ['unknown','unavailable','none',''] else 0 }}
          max_length_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).ml if p not in ['unknown','unavailable','none',''] else 0 }}
          ideal_min_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).imin if p not in ['unknown','unavailable','none',''] else 0 }}
          ideal_max_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).imax if p not in ['unknown','unavailable','none',''] else 0 }}
          opportunistic_enabled: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ ((p | from_json).opp == 1) if p not in ['unknown','unavailable','none',''] else false }}
          opportunistic_min_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).omin if p not in ['unknown','unavailable','none',''] else 0 }}
          opportunistic_max_ft: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).omax if p not in ['unknown','unavailable','none',''] else 0 }}
          manual_override: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ ((p | from_json).man == 1) if p not in ['unknown','unavailable','none',''] else false }}
          base_zones: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).bz if p not in ['unknown','unavailable','none',''] else 'none' }}
          final_zones: >
            {% set p = states('sensor.hc_dispatch_guardrail_payload') %}
            {{ (p | from_json).fz if p not in ['unknown','unavailable','none',''] else 'none' }}

      - name: "HC Dispatch Suggested Batch"
        unique_id: hc_dispatch_suggested_batch
        icon: mdi:vector-link
        state: >
          {{ state_attr('sensor.hc_dispatch_guardrail','suggested_batch') or 'idle' }}
        attributes:
          algorithm: "{{ states('input_select.hc_dispatch_algorithm') }}"
          profile: "{{ states('input_select.hc_dispatch_profile') }}"
          batch_window_sec: "{{ states('input_number.hc_dispatch_batch_window_sec')|int(180) }}"
          gate_enabled: "{{ is_state('input_boolean.hc_enable_cold_tolerance_gate','on') }}"
          gate_threshold_f: "{{ states('input_number.hc_cold_tolerance')|float(0) }}"
          guardrail_status: "{{ states('sensor.hc_dispatch_guardrail') }}"
          batch_length_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','batch_length_ft') }}"
          base_length_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','base_length_ft') }}"
          callers_length_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','callers_length_ft') }}"
          max_length_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','max_length_ft') }}"
          ideal_min_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','ideal_min_ft') }}"
          ideal_max_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','ideal_max_ft') }}"
          opportunistic_enabled: "{{ state_attr('sensor.hc_dispatch_guardrail','opportunistic_enabled') }}"
          opportunistic_min_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','opportunistic_min_ft') }}"
          opportunistic_max_ft: "{{ state_attr('sensor.hc_dispatch_guardrail','opportunistic_max_ft') }}"
          manual_override: "{{ state_attr('sensor.hc_dispatch_guardrail','manual_override') }}"
          base_zones: "{{ state_attr('sensor.hc_dispatch_guardrail','base_zones') }}"
          final_zones: "{{ state_attr('sensor.hc_dispatch_guardrail','final_zones') }}"

      # Avg ON time today = (hours_today*60)/call_starts_today (rough proxy for cycle length)
      - name: "HC Z1 Avg ON Minutes Today"
        unique_id: hc_z1_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z1_first_floor_bedroom_bath_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z1_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z2 Avg ON Minutes Today"
        unique_id: hc_z2_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z2_office_upper_guest_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z2_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z3 Avg ON Minutes Today"
        unique_id: hc_z3_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z3_basement_bath_common_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z3_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z4 Avg ON Minutes Today"
        unique_id: hc_z4_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z4_garage_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z4_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z5 Avg ON Minutes Today"
        unique_id: hc_z5_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z5_first_floor_living_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z5_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z6 Avg ON Minutes Today"
        unique_id: hc_z6_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z6_master_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z6_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z7 Avg ON Minutes Today"
        unique_id: hc_z7_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z7_basement_bar_tv_south_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z7_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z8 Avg ON Minutes Today"
        unique_id: hc_z8_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z8_dining_room_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z8_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

      - name: "HC Z9 Avg ON Minutes Today"
        unique_id: hc_z9_avg_on_minutes_today
        unit_of_measurement: "min"
        state: >
          {% set h = states('sensor.hc_z9_basement_bedroom_call_for_heat_hours_today')|float(0) %}
          {% set c = states('counter.hc_dispatch_calls_z9_today')|int(0) %}
          {{ (h*60 / c) | round(1) if c>0 else 0 }}

  - binary_sensor:
      - name: "HC Dispatch Short Cycle Risk"
        unique_id: hc_dispatch_short_cycle_risk
        device_class: problem
        state: >
          {% set active_ns = namespace(list=[]) %}
          {% for z in range(1,10) %}
            {% if is_state('binary_sensor.hc_z' ~ z ~ '_call_for_heat','on') %}
              {% set active_ns.list = active_ns.list + ['z' ~ z] %}
            {% endif %}
          {% endfor %}
          {% set active = active_ns.list %}
          {% if active|length != 1 %}
            false
          {% else %}
            {% set z = active[0] %}
            {% set avg_map = {
              'z1':'sensor.hc_z1_avg_on_minutes_today','z2':'sensor.hc_z2_avg_on_minutes_today',
              'z3':'sensor.hc_z3_avg_on_minutes_today','z4':'sensor.hc_z4_avg_on_minutes_today',
              'z5':'sensor.hc_z5_avg_on_minutes_today','z6':'sensor.hc_z6_avg_on_minutes_today',
              'z7':'sensor.hc_z7_avg_on_minutes_today','z8':'sensor.hc_z8_avg_on_minutes_today',
              'z9':'sensor.hc_z9_avg_on_minutes_today'
            } %}
            {% set cyc_map = {
              'z1':'counter.hc_dispatch_calls_z1_today','z2':'counter.hc_dispatch_calls_z2_today',
              'z3':'counter.hc_dispatch_calls_z3_today','z4':'counter.hc_dispatch_calls_z4_today',
              'z5':'counter.hc_dispatch_calls_z5_today','z6':'counter.hc_dispatch_calls_z6_today',
              'z7':'counter.hc_dispatch_calls_z7_today','z8':'counter.hc_dispatch_calls_z8_today',
              'z9':'counter.hc_dispatch_calls_z9_today'
            } %}
            {% set avg = states(avg_map[z])|float(999) %}
            {% set cycles = states(cyc_map[z])|int(0) %}
            {{ cycles >= 4 and avg > 0 and avg < 8 }}
          {% endif %}

automation:
  - id: hc_dispatch_store_last_suggested_batch
    alias: "HC Dispatcher Advisory - Store Last Suggested Batch"
    mode: queued
    trigger:
      - platform: state
        entity_id: sensor.hc_dispatch_suggested_batch
    condition:
      - condition: template
        value_template: >
          {{ trigger.to_state is not none and trigger.to_state.state not in ['idle','unknown','unavailable','none',''] }}
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.hc_dispatch_last_suggested_batch
        data:
          value: "{{ trigger.to_state.state }}"

  - id: hc_dispatch_advisory_track_call_starts
    alias: "HC Dispatcher Advisory - Track Call Starts"
    mode: queued
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.hc_z1_call_for_heat
          - binary_sensor.hc_z2_call_for_heat
          - binary_sensor.hc_z3_call_for_heat
          - binary_sensor.hc_z4_call_for_heat
          - binary_sensor.hc_z5_call_for_heat
          - binary_sensor.hc_z6_call_for_heat
          - binary_sensor.hc_z7_call_for_heat
          - binary_sensor.hc_z8_call_for_heat
          - binary_sensor.hc_z9_call_for_heat
        from: "off"
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.hc_dispatcher_advisory_enabled
        state: "on"
    action:
      - variables:
          z: "{{ trigger.entity_id.split('.')[-1].split('_')[1] }}"   # z1..z9
          now_str: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
          now_ts: "{{ as_timestamp(now()) }}"
          window: "{{ states('input_number.hc_dispatch_batch_window_sec')|int(180) }}"
          pairs:
            - { a: "z3", b: "z7", counter: "counter.hc_dispatch_pair_z3_z7" }
            - { a: "z3", b: "z9", counter: "counter.hc_dispatch_pair_z3_z9" }
            - { a: "z7", b: "z9", counter: "counter.hc_dispatch_pair_z7_z9" }
            - { a: "z1", b: "z5", counter: "counter.hc_dispatch_pair_z1_z5" }
            - { a: "z1", b: "z8", counter: "counter.hc_dispatch_pair_z1_z8" }
            - { a: "z5", b: "z8", counter: "counter.hc_dispatch_pair_z5_z8" }
            - { a: "z2", b: "z6", counter: "counter.hc_dispatch_pair_z2_z6" }

      - service: input_datetime.set_datetime
        target:
          entity_id: "{{ 'input_datetime.hc_dispatch_last_on_' ~ z }}"
        data:
          datetime: "{{ now_str }}"

      - service: counter.increment
        target:
          entity_id: "{{ 'counter.hc_dispatch_calls_' ~ z ~ '_today' }}"

      - repeat:
          for_each: "{{ pairs }}"
          sequence:
            - variables:
                a: "{{ repeat.item.a }}"
                b: "{{ repeat.item.b }}"
                other: "{{ b if a == z else a }}"
                other_state: "{{ states('input_datetime.hc_dispatch_last_on_' ~ other) }}"
                other_ts: >
                  {% if other_state not in ['unknown','unavailable','none',''] %}
                    {{ as_timestamp(other_state) }}
                  {% else %}
                    0
                  {% endif %}
            - choose:
                - conditions:
                    - condition: template
                      value_template: >
                        {{ (a == z or b == z) and (other_ts|float(0) > 0) and ((now_ts - (other_ts|float(0))) <= window) }}
                  sequence:
                    - service: counter.increment
                      target:
                        entity_id: "{{ repeat.item.counter }}"

  - id: hc_dispatch_advisory_reset_counters_daily
    alias: "HC Dispatcher Advisory - Reset Counters Daily"
    trigger:
      - platform: time
        at: "00:00:05"
    action:
      - service: counter.reset
        target:
          entity_id:
            - counter.hc_dispatch_calls_z1_today
            - counter.hc_dispatch_calls_z2_today
            - counter.hc_dispatch_calls_z3_today
            - counter.hc_dispatch_calls_z4_today
            - counter.hc_dispatch_calls_z5_today
            - counter.hc_dispatch_calls_z6_today
            - counter.hc_dispatch_calls_z7_today
            - counter.hc_dispatch_calls_z8_today
            - counter.hc_dispatch_calls_z9_today
            - counter.hc_dispatch_pair_z3_z7
            - counter.hc_dispatch_pair_z3_z9
            - counter.hc_dispatch_pair_z7_z9
            - counter.hc_dispatch_pair_z1_z5
            - counter.hc_dispatch_pair_z1_z8
            - counter.hc_dispatch_pair_z5_z8
            - counter.hc_dispatch_pair_z2_z6
